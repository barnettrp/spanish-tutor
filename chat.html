<script>
  const $ = (id) => document.getElementById(id);

  $("join").addEventListener("click", async () => {
    const name = $("name").value.trim();
    const code = $("code").value.trim();
    const msg  = $("msg");

    msg.textContent = "";

    if (!name || !code) {
      msg.textContent = "Please enter both your name and the party code.";
      return;
    }

    try {
      const r = await fetch("/api/join", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, code })
      });

      // Try to parse JSON, but don't crash if it's not JSON
      const text = await r.text();
      let data = null;
      try { data = JSON.parse(text); } catch {}

      if (!r.ok) {
        const serverMsg = (data && (data.error || data.message)) || text || "Could not join.";
        msg.textContent = `Unable to join. HTTP ${r.status}. ${serverMsg.slice(0,200)}`;
        return;
      }

      // ✅ Save session for chat.html
      const token = (data && data.token) || `dev_${Math.random().toString(36).slice(2)}`;
      localStorage.setItem("party_token", token);
      localStorage.setItem("party_name", name);
      localStorage.setItem("party_code", code);

      // ✅ Go to chat.html (not conversation.html)
      location.href = "chat.html";
    } catch (err) {
      msg.textContent = `Network error: ${err && err.message ? err.message : err}`;
    }
  });
</script>
